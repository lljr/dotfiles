#+STARTUP: overview hidestars
#+AUTHOR: Jonathan Rostran
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el :comments no :results silent

* Emacs Setup
 Emacs documents all of its variables.
 When in doubt, don't hesistate to invoke ~M-x describe-variable~ or ~M-x describe-function~.
 Keychords may also be used: ~C-h v [variable symbole]~, ~C-h f [function symbol]~ respectively.
** Changes to default Emacs UI
#+BEGIN_SRC emacs-lisp
  (menu-bar-mode -1)            ; Disable for more headspace
  (tool-bar-mode -1)			; Remove toolbar
  (scroll-bar-mode -1) 			; Remove scroll bar
  (save-place-mode 1)           ; Remember cursor position
  (display-time-mode 1)         ; Display time in modeline
  (blink-cursor-mode 0)			; Stop cursor blink
  (load-theme 'wombat nil)
#+END_SRC

** General changes
#+BEGIN_SRC emacs-lisp
  (setq-default inhibit-startup-message t              ; Don't show default emacs startup screen
                window-combination-resize t            ; Resize windows proportionally
                display-time-default-load-average nil  ; Don't show system load time in modeline
                indent-tabs-mode nil                   ; Stop using tabs to indent
                tab-width 4 				           ; Change default tab width

                ;; My machine has enough memory to increase the default values
                gc-cons-threshold 50000000
                large-file-warning-threshold 100000000

                ;; Increase default max recursion depth (when coding in Elisp)
                max-specpdl-size 19500
                max-lisp-eval-depth 24000

                bidi-paragraph-direction 'left-to-right ; Just work with left to right langs
                bidi-inhibit-bpa t
                )

  ;; Toggle features not available in a fresh Emacs install
  (put 'downcase-region 'disabled nil)                 ; Allow use of C-x C-l (downcase region)
  (put 'upcase-region 'disabled nil)                   ; Allow use of C-x C-u (capitalize region)
  (put 'narrow-to-region 'disabled nil) 	           ; Allows to narrow region

  ;; Useful Register setup when appending/prepending
  (setq register-separator ?+)
  (set-register register-separator "\n\n")
  (set-register ?z '(file . "~/dotfiles/emacs/config.org"))      ; Allows quick jump to config

  ;; Useful functionality
  (add-hook 'before-save-hook 'delete-trailing-whitespace)       ; Remove trailing whitespace on save
  (add-hook 'after-save-hook
            'executable-make-buffer-file-executable-if-script-p  ; Automatically makes script file executable
            )

  ;; Load extra manuals
  (add-to-list 'Info-default-directory-list "~/Documents/Info")

  ;; Pick up global NPM packages
  (add-to-list 'exec-path "~/node_modules/.bin")
  (add-to-list 'exec-path "~/.nvm/versions/node/v14.2.0/bin/")

  (prefer-coding-system 'utf-8)
  (global-set-key (kbd "C-x k") 'kill-this-buffer) ; Kill the current buffer without warning

  (global-so-long-mode 1)
  (fset 'yes-or-no-p 'y-or-n-p) ; Prompts that require 'yes' or 'no' accept 'y' or 'n'
#+END_SRC

** Custom prefix keys
 Some functions get called often but are not binded to a keychord by default.
 Custom prefix keys allows defining a key and bind it to a function.
#+BEGIN_SRC emacs-lisp

  ;; Keys may be binded globally like below
  (global-set-key (kbd "<f8>") 'find-file-at-point)   ; Jump to file: useful for opening imgs in html 'img' tag
  (global-set-key (kbd "<C-M-return>") 'delete-other-windows)


  ;; Keys may be binded to a "prefix" key to create a "keymap"
  ;; In other words, this allows grouping several functions to a key
  ;; and prevents shadowing of other keymaps that may exist in a mode

  ;; Define C-z key map
  (define-prefix-command 'my-super-z-map)
  ;; Bind C-z to custom prefix command
  (global-set-key (kbd "C-z") 'my-super-z-map)

  ;; Set of mapped keys in `C-z'
  (define-key my-super-z-map (kbd "o") 'browse-url-at-point)
  (define-key my-super-z-map (kbd "r") 'revert-buffer)
  (define-key my-super-z-map (kbd "a") 'add-file-local-variable-prop-line)
#+END_SRC

* Packages
** Vertico / CtrlF / Marginalia
  Better buffer search and improved minibuffer experience
  #+begin_src emacs-lisp
    (vertico-mode)
    (marginalia-mode)
    (ctrlf-mode +1)

    (add-hook 'pdf-isearch-minor-mode-hook
              (lambda () (ctrlf-local-mode -1))) ; Disable when reading PDFs

    (setq completion-styles '(orderless)
          completion-category-defaults nil
          completion-category-overrides '((file (styles . (partial-completion)))))

    ;; Add prompt indicator to `completing-read-multiple'.
    (defun crm-indicator (args)
      (cons (concat "[CRM] " (car args)) (cdr args)))
    (advice-add #'completing-read-multiple :filter-args #'crm-indicator)


    ;; Do not allow the cursor in the minibuffer prompt
    (setq minibuffer-prompt-properties
          '(read-only t cursor-intangible t face minibuffer-prompt))
    (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

    (advice-add #'vertico--setup :after
                (lambda (&rest _)
                  (setq-local completion-auto-help nil
                              completion-show-inline-help nil)))
  #+end_src
** Company
Auto-completion in Emacs.
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook 'global-company-mode)

  (with-eval-after-load 'company
      (setq company-echo-delay 0.3
        company-idle-delay 1
        company-tooltip-limit 10
        company-tooltip-align-annotations t
        company-minimum-prefix-length 2))
#+END_SRC
** Dired
#+BEGIN_SRC emacs-lisp
  (setq dired-recursive-copies 'always ; “always” means no asking
        dired-recursive-deletes 'top ; “top” means ask once
        dired-dwim-target t)

  (add-hook 'dired-mode-hook '(lambda ()
                                (dired-hide-details-mode 1)))

  (put 'dired-find-alternate-file 'disabled nil)
#+END_SRC
** Ibuffer
Manage several buffers interactively
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-x C-b") 'ibuffer)
#+END_SRC

** Web Development
*** CSS
#+BEGIN_SRC emacs-lisp
  ;; Remap css-lookup-symbol to fix global counsel-mode key rebindings
  (add-hook 'css-mode-hook
            (lambda () (define-key css-mode-map (kbd "C-h S") 'css-lookup-symbol)))
#+END_SRC
*** Web Mode
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("/templates/.*\\.html?\\'" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.\\(handlebars\\|hbs\\)\\'" . web-mode))

  (with-eval-after-load 'web-mode
    (setq	web-mode-engines-alist
          '(("ctemplate" . "\\.\\(handlebars\\|hbs\\)\\'")
            ("django" . "./templates/.*\\.html?\\'"))

          web-mode-enable-html-entities-fontification t
          web-mode-enable-css-colorization t
          web-mode-enable-current-column-highlight t
          web-mode-markup-indent-offset 2
          web-mode-enable-auto-closing t
          web-mode-enable-auto-opening t
          web-mode-enable-auto-pairing nil
          web-mode-enable-auto-indentation nil

          web-mode-code-indent-offset 2))

#+END_SRC
*** Javascript
  #+begin_src emacs-lisp
    (setq js-indent-level 2)
  #+end_src
** Lisp
*** Clojure
  #+begin_src emacs-lisp
    (setq cider-font-lock-dynamically '(macro core function var))
    (setq cider-eval-result-prefix ";; => ")
    (setq cider-repl-display-help-banner nil)
  #+end_src

**** Exec-path/CLJS setup
    To use Node with NVM use this
    #+begin_src emacs-lisp
      (exec-path-from-shell-copy-env "PATH")
      (exec-path-from-shell-initialize)
    #+end_src
*** Scheme
 #+begin_src emacs-lisp
   (setq geiser-active-implementations '(guile))

   (with-eval-after-load 'geiser-guile
     (add-to-list 'geiser-guile-load-path "~/src/guix"))
 #+end_src
** Yasnippet
#+begin_src emacs-lisp
  (with-eval-after-load 'yasnippet
    (add-to-list 'yas-snippet-dirs "~/src/guix/etc/snippets")
    (add-to-list 'yas-snippet-dirs "~/.emacs.d/snippets")
    (yas-reload-all)
    (add-hook 'js-mode-hook #'yas-minor-mode))
#+end_src
** Org
#+begin_src emacs-lisp
  (global-set-key (kbd "<f6>") 'org-capture)
  (with-eval-after-load 'org
    (visual-line-mode 1) ; wrap lines
    (setq org-src-fontify-natively t    ; highlight syntax in code source blocks
          org-latex-pdf-process
          (let
              ;; https://tex.stackexchange.com/questions/2099/how-to-include-svg-diagrams-in-latex
              ((cmd (concat "lualatex -interaction=nonstopmode --shell-escape"
                            " --synctex=1"
                            ;; https://tex.stackexchange.com/questions/124246/uninformative-error-message-when-using-auctex
                            "--file-line-error"
                            " -output-directory %o %f")))
            (list cmd
                  "cd %o; if test -r %b.idx; then makeindex %b.idx; fi"
                  "cd %o; bibtex %b"
                  cmd
                  cmd))

          org-catch-invisible-edits t
          ))

  ;; Org Roam Setup
  ;; (setq org-roam-v2-ack t) ;; disable v1 to v2 migration warning
  ;; (setq org-roam-directory (file-truename "~/org-roam"))
  ;; (org-roam-setup)
  ;; (global-set-key (kbd "C-c n l") 'org-roam-buffer-toggle)
  ;; (global-set-key (kbd "C-c n f") 'org-roam-node-find)
  ;; (global-set-key (kbd "C-c n i") 'org-roam-node-insert)


  ;; Org Babel Setup
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((shell . t)
     (latex . t)
     (python . t)
     (ditaa . t)))


#+end_src
*** Org Tree Slide
Create slide-shows with Org mode.
#+begin_src emacs-lisp
  (with-eval-after-load 'org-tree-slide-mode
    (org-image-actual-width nil))
#+end_src
** Reading PDF and EPUB files

*** PDF Tools
   Read PDF files in Emacs buffers.
 #+BEGIN_SRC emacs-lisp
   (pdf-loader-install)
 #+END_SRC

***  Epub
   Read Epub files in Emacs buffers.
   #+begin_src emacs-lisp
     (setq nov-text-width 90
           nov-text-width t
           visual-fill-column-center-text t)

     (add-hook 'nov-mode-hook 'visual-line-mode)
     (add-hook 'nov-mode-hook 'visual-fill-column-mode)
     (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))
   #+end_src
** Extras
Nice to have packages and functionality.
Most of these improve coding experience.
*** Emacs
**** Misc
 #+begin_src emacs-lisp
   ;; Highlight matching parenthesis
   (show-paren-mode t)

   ;; Electric Layout Mode
   (add-hook 'css-mode 'electric-layout-mode)    ; insert newline after the insertion of '{'

   (electric-indent-mode +1) ; toggle on the fly re-indentation

   ;; Electric Pairs
   (add-hook 'mhtml-mode-hook 'electric-pair-local-mode)
   (add-hook 'emacs-lisp-mode-hook 'electric-pair-local-mode)
   (add-hook 'clojure-mode-hook 'electric-pair-local-mode)
   (add-hook 'lisp-interaction-mode-hook 'electric-pair-local-mode)
   (add-hook 'web-mode-hook 'electric-pair-local-mode)
   (add-hook 'ielm-mode-hook 'electric-pair-local-mode)
   (add-hook 'js-mode-hook 'electric-pair-local-mode)
   (add-hook 'org-mode-hook 'electric-pair-local-mode)
   (add-hook 'scheme-mode-hook 'electric-pair-local-mode)
   (add-hook 'python-mode-hook 'electric-pair-local-mode)
   (add-hook 'css-mode-hook 'electric-pair-local-mode)

   ;; Add extra pairs for org mode
   (defvar org-electric-pairs '((?= . ?=)) "Electric pairs for org-mode.")
   (defun org-add-electric-pairs ()
     (setq-local electric-pair-pairs (append electric-pair-pairs org-electric-pairs))
     (setq-local electric-pair-text-pairs electric-pair-pairs))
   (add-hook 'org-mode-hook 'org-add-electric-pairs)

   ;; Add extra pairs for js-mode
   (defvar js-mode-electric-pairs '((?` . ?`)) "Electric pairs for js-mode.")
   (defun js-mode-add-electric-pairs ()
     (setq-local electric-pair-pairs (append electric-pair-pairs js-mode-electric-pairs))
     (setq-local electric-pair-text-pairs electric-pair-pairs))
   (add-hook 'js-mode-hook 'js-mode-add-electric-pairs)
   (add-hook 'mhtml-mode-hook 'js-mode-add-electric-pairs) ; needs it for `script` tags

   ;; Add extra pairs for web mode (jinja)
   (defvar web-mode-jinja-electric-pairs '((?% . ?%) (?< . ?>)) "Electric pairs for web-mode.")
   (defun web-mode-add-jinja-electric-pairs ()
     (setq-local electric-pair-pairs (append electric-pair-pairs web-mode-jinja-electric-pairs)))
   (add-hook 'web-mode-hook 'web-mode-add-jinja-electric-pairs)

   ;; Subword Mode
   (add-hook 'js-mode-hook #'subword-mode)
   (add-hook 'python-mode-hook #'subword-mode)
   (add-hook 'c-mode-hook #'subword-mode)
   (add-hook 'clojure-mode-hook #'subword-mode)

   ;; Enable Dash font-locking
   (eval-after-load 'dash '(dash-enable-font-lock))
 #+end_src

**** Prettify Symbols
  #+BEGIN_SRC emacs-lisp
    (global-prettify-symbols-mode t)

    (defun my-add-pretty-lambda ()
      "Make some word or string show as pretty Unicode symbols"
      (push '("lambda" . 955) prettify-symbols-alist)	      ; λ
      (push '("->" . 8594) prettify-symbols-alist)              ; →
      (push '("=>" . 8658) prettify-symbols-alist)              ; ⇒
      (push '("map" . 8614) prettify-symbols-alist) 	      ; ↦
      )

    (add-hook 'tex-mode-hook 'my-add-pretty-lambda)

    (add-hook 'org-mode-hook (lambda ()
                               "Beautify Org Checkbox Symbol"
                               (push '("[ ]" .  "▢") prettify-symbols-alist)
                               (push '("*" .  "◉") prettify-symbols-alist)
                               (push '("[X]" . "☑" ) prettify-symbols-alist)
                               (push '("[-]" . "❍" ) prettify-symbols-alist)))

    (add-hook 'emacs-lisp-mode-hook
              (lambda ()
                "Beautify Emacs Symbols"
                (push '("<=" . "≤") prettify-symbols-alist)))

    (add-hook 'scheme-mode-hook
              (lambda ()
                "Beautify Emacs Symbols"
                (push '("<=" . "≤") prettify-symbols-alist)))
  #+END_SRC
*** Not included in Emacs
**** Iedit
#+begin_src emacs-lisp
  (global-set-key (kbd "C-;") 'iedit-mode)
#+end_src
**** Rainbow Delimiters
 #+begin_src emacs-lisp
   (custom-set-faces
          '(rainbow-delimiters-depth-1-face ((t (:foreground "blue violet"))))
          '(rainbow-delimiters-depth-2-face ((t (:foreground "red"))))
          '(rainbow-delimiters-depth-3-face ((t (:foreground "cyan3"))))
          '(rainbow-delimiters-depth-4-face ((t (:foreground "blue"))))
          '(rainbow-delimiters-depth-5-face ((t (:foreground "gold"))))
          '(rainbow-delimiters-depth-6-face ((t (:foreground "lavender"))))
          '(rainbow-delimiters-depth-7-face ((t (:foreground "ivory"))))
          '(rainbow-delimiters-depth-8-face ((t (:foreground "magenta"))))
          '(rainbow-delimiters-depth-9-face ((t (:foreground "red")))))

   (add-hook 'clojure-mode-hook #'rainbow-delimiters-mode)
   (add-hook 'emacs-lisp-mode-hook #'rainbow-delimiters-mode)
   (add-hook 'ielm-mode-hook #'rainbow-delimiters-mode)
   (add-hook 'lisp-interaction-mode-hook #'rainbow-delimiters-mode)
   (add-hook 'lisp-mode-hook #'rainbow-delimiters-mode)
 #+end_src
**** Multiple Cursors
#+begin_src emacs-lisp
  (global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
  (global-set-key (kbd "C->") 'mc/mark-next-like-this)
  (global-set-key (kbd "C-<") 'mc/mark-previous-like-this)
  (global-set-key (kbd "C-c C-<") 'mc/mark-all-like-this)
#+end_src
